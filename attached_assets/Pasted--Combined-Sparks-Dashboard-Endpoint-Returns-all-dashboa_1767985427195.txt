/**
 * Combined Sparks Dashboard Endpoint
 * 
 * Returns all dashboard data in a single request:
 * - Today's spark
 * - Featured sparks
 * - Reflection card
 * - User's spark progress (if authenticated)
 * 
 * Reduces 4+ API calls to 1.
 */

import { Router } from 'express';
import { db } from '../db';
import { sql } from 'drizzle-orm';
import { loadUser } from '../middleware/auth';

const router = Router();

interface DashboardResponse {
  todaySpark: Spark | null;
  featuredSparks: Spark[];
  reflectionCard: ReflectionCard | null;
  userProgress: SparkProgress | null;
  leaderPrayer: LeaderPrayerSession | null;
  serverTime: string;
  loadTime: number;
}

interface Spark {
  id: number;
  title: string;
  scripture: string;
  scriptureReference: string;
  teaching: string;
  reflection: string;
  actionStep: string;
  prayer: string;
  category: string;
  audioUrl: string | null;
  publishedAt: string;
  dayNumber: number;
}

interface ReflectionCard {
  id: number;
  prompt: string;
  scripture: string | null;
  category: string;
}

interface SparkProgress {
  completedToday: boolean;
  currentStreak: number;
  totalCompleted: number;
  lastCompletedAt: string | null;
}

interface LeaderPrayerSession {
  id: number;
  title: string;
  scheduledAt: string;
  leader: {
    name: string;
    avatarUrl: string | null;
  };
}

/**
 * GET /api/sparks/dashboard
 * 
 * Combined endpoint for dashboard data.
 */
router.get('/dashboard', loadUser, async (req, res) => {
  const startTime = Date.now();
  
  try {
    // Run all queries in parallel
    const [
      todaySpark,
      featuredSparks,
      reflectionCard,
      userProgress,
      leaderPrayer,
    ] = await Promise.all([
      getTodaySpark(),
      getFeaturedSparks(3),
      getTodayReflectionCard(),
      req.user ? getUserSparkProgress(req.user.id) : null,
      getUpcomingLeaderPrayer(),
    ]);
    
    const response: DashboardResponse = {
      todaySpark,
      featuredSparks,
      reflectionCard,
      userProgress,
      leaderPrayer,
      serverTime: new Date().toISOString(),
      loadTime: Date.now() - startTime,
    };
    
    // Cache for 5 minutes (static content)
    res.set('Cache-Control', 'public, max-age=300');
    res.json(response);
  } catch (error) {
    console.error('Error in /api/sparks/dashboard:', error);
    res.status(500).json({ 
      error: 'Failed to load dashboard data',
      loadTime: Date.now() - startTime,
    });
  }
});

// ============================================================================
// Query Functions
// ============================================================================

async function getTodaySpark(): Promise<Spark | null> {
  try {
    // Get today's spark based on day number in the cycle
    // Assuming sparks are numbered 1-365 and cycle yearly
    const dayOfYear = getDayOfYear();
    
    const result = await db.execute(sql`
      SELECT 
        id,
        title,
        scripture,
        scripture_reference,
        teaching,
        reflection,
        action_step,
        prayer,
        category,
        audio_url,
        published_at,
        day_number
      FROM sparks
      WHERE day_number = ${dayOfYear}
        AND is_published = true
      LIMIT 1
    `);
    
    if (!result.rows || result.rows.length === 0) {
      // Fallback: get the most recent published spark
      const fallback = await db.execute(sql`
        SELECT 
          id, title, scripture, scripture_reference, teaching,
          reflection, action_step, prayer, category, audio_url,
          published_at, day_number
        FROM sparks
        WHERE is_published = true
        ORDER BY published_at DESC
        LIMIT 1
      `);
      
      return fallback.rows[0] ? mapSparkRow(fallback.rows[0]) : null;
    }
    
    return mapSparkRow(result.rows[0]);
  } catch (error) {
    console.error('Error getting today spark:', error);
    return null;
  }
}

async function getFeaturedSparks(limit: number): Promise<Spark[]> {
  try {
    const result = await db.execute(sql`
      SELECT 
        id, title, scripture, scripture_reference, teaching,
        reflection, action_step, prayer, category, audio_url,
        published_at, day_number
      FROM sparks
      WHERE is_published = true
        AND is_featured = true
      ORDER BY featured_order ASC, published_at DESC
      LIMIT ${limit}
    `);
    
    return (result.rows || []).map(mapSparkRow);
  } catch (error) {
    console.error('Error getting featured sparks:', error);
    return [];
  }
}

async function getTodayReflectionCard(): Promise<ReflectionCard | null> {
  try {
    // Rotate through reflection cards based on day of year
    const dayOfYear = getDayOfYear();
    
    const result = await db.execute(sql`
      SELECT id, prompt, scripture, category
      FROM reflection_cards
      WHERE is_active = true
      ORDER BY id
      LIMIT 1
      OFFSET ${(dayOfYear - 1) % 100}
    `);
    
    if (!result.rows || result.rows.length === 0) {
      return null;
    }
    
    const row = result.rows[0] as any;
    return {
      id: row.id,
      prompt: row.prompt,
      scripture: row.scripture,
      category: row.category,
    };
  } catch (error) {
    console.error('Error getting reflection card:', error);
    return null;
  }
}

async function getUserSparkProgress(userId: number): Promise<SparkProgress | null> {
  try {
    const today = new Date().toISOString().split('T')[0];
    
    const result = await db.execute(sql`
      SELECT 
        (SELECT COUNT(*) FROM user_spark_completions 
         WHERE user_id = ${userId} AND DATE(completed_at) = ${today}) > 0 as completed_today,
        COALESCE(us.current_streak, 0) as current_streak,
        (SELECT COUNT(*) FROM user_spark_completions WHERE user_id = ${userId}) as total_completed,
        (SELECT MAX(completed_at) FROM user_spark_completions WHERE user_id = ${userId}) as last_completed_at
      FROM users u
      LEFT JOIN user_streaks us ON us.user_id = u.id
      WHERE u.id = ${userId}
    `);
    
    if (!result.rows || result.rows.length === 0) {
      return null;
    }
    
    const row = result.rows[0] as any;
    return {
      completedToday: row.completed_today,
      currentStreak: Number(row.current_streak) || 0,
      totalCompleted: Number(row.total_completed) || 0,
      lastCompletedAt: row.last_completed_at,
    };
  } catch (error) {
    console.error('Error getting user spark progress:', error);
    return null;
  }
}

async function getUpcomingLeaderPrayer(): Promise<LeaderPrayerSession | null> {
  try {
    const result = await db.execute(sql`
      SELECT 
        lps.id,
        lps.title,
        lps.scheduled_at,
        u.first_name || ' ' || u.last_name as leader_name,
        u.avatar_url as leader_avatar
      FROM leader_prayer_sessions lps
      JOIN users u ON lps.leader_id = u.id
      WHERE lps.scheduled_at > NOW()
        AND lps.is_cancelled = false
      ORDER BY lps.scheduled_at ASC
      LIMIT 1
    `);
    
    if (!result.rows || result.rows.length === 0) {
      return null;
    }
    
    const row = result.rows[0] as any;
    return {
      id: row.id,
      title: row.title,
      scheduledAt: row.scheduled_at,
      leader: {
        name: row.leader_name,
        avatarUrl: row.leader_avatar,
      },
    };
  } catch (error) {
    console.error('Error getting leader prayer:', error);
    return null;
  }
}

// ============================================================================
// Helpers
// ============================================================================

function getDayOfYear(): number {
  const now = new Date();
  const start = new Date(now.getFullYear(), 0, 0);
  const diff = now.getTime() - start.getTime();
  const oneDay = 1000 * 60 * 60 * 24;
  return Math.floor(diff / oneDay);
}

function mapSparkRow(row: any): Spark {
  return {
    id: row.id,
    title: row.title,
    scripture: row.scripture,
    scriptureReference: row.scripture_reference,
    teaching: row.teaching,
    reflection: row.reflection,
    actionStep: row.action_step,
    prayer: row.prayer,
    category: row.category,
    audioUrl: row.audio_url,
    publishedAt: row.published_at,
    dayNumber: row.day_number,
  };
}

export const sparksDashboardRoutes = router;