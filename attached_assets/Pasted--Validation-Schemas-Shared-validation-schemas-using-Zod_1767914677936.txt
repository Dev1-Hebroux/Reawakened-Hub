/**
 * Validation Schemas
 * 
 * Shared validation schemas using Zod for consistent validation
 * across client and server. These schemas serve as the single
 * source of truth for data validation rules.
 */

import { z } from 'zod';

// ============================================================================
// Common Validators
// ============================================================================

export const emailSchema = z
  .string()
  .email('Invalid email address')
  .min(1, 'Email is required')
  .max(255, 'Email is too long');

export const passwordSchema = z
  .string()
  .min(8, 'Password must be at least 8 characters')
  .max(128, 'Password is too long')
  .regex(/[A-Z]/, 'Password must contain at least one uppercase letter')
  .regex(/[a-z]/, 'Password must contain at least one lowercase letter')
  .regex(/[0-9]/, 'Password must contain at least one number');

export const idSchema = z.number().int().positive();

export const uuidSchema = z.string().uuid();

export const slugSchema = z
  .string()
  .min(1)
  .max(100)
  .regex(/^[a-z0-9]+(?:-[a-z0-9]+)*$/, 'Invalid slug format');

export const urlSchema = z.string().url().or(z.literal(''));

export const dateSchema = z.coerce.date();

export const contentCategorySchema = z.enum([
  'faith',
  'prayer',
  'scripture',
  'relationships',
  'marriage',
  'parenting',
  'leadership',
  'career',
  'finances',
  'health',
  'mental_health',
  'purpose',
  'community',
  'evangelism',
  'discipleship',
]);

export const difficultyLevelSchema = z.enum(['beginner', 'intermediate', 'advanced']);

export const paginationSchema = z.object({
  page: z.coerce.number().int().min(1).default(1),
  pageSize: z.coerce.number().int().min(1).max(100).default(20),
  cursor: z.string().optional(),
  sortBy: z.string().optional(),
  sortOrder: z.enum(['asc', 'desc']).default('desc'),
});

// ============================================================================
// User Schemas
// ============================================================================

export const userRoleSchema = z.enum(['member', 'leader', 'admin', 'super_admin']);

export const userProfileUpdateSchema = z.object({
  firstName: z.string().min(1).max(100).optional(),
  lastName: z.string().min(1).max(100).optional(),
  profileImageUrl: urlSchema.optional().nullable(),
});

export const notificationSettingsSchema = z.object({
  dailyReminders: z.boolean(),
  dailyReminderTime: z.string().regex(/^([01]\d|2[0-3]):([0-5]\d)$/),
  streakAlerts: z.boolean(),
  groupNotifications: z.boolean(),
  emailDigest: z.enum(['none', 'daily', 'weekly']),
  pushEnabled: z.boolean(),
});

export const displaySettingsSchema = z.object({
  theme: z.enum(['light', 'dark', 'system']),
  fontSize: z.enum(['small', 'medium', 'large']),
  reducedMotion: z.boolean(),
  highContrast: z.boolean(),
});

export const privacySettingsSchema = z.object({
  profileVisibility: z.enum(['private', 'group', 'public']),
  showStreak: z.boolean(),
  showProgress: z.boolean(),
  allowAccountabilityRequests: z.boolean(),
});

export const userPreferencesSchema = z.object({
  notificationSettings: notificationSettingsSchema,
  displaySettings: displaySettingsSchema,
  privacySettings: privacySettingsSchema,
});

export const wheelOfLifeScoresSchema = z.object({
  faith: z.number().min(1).max(10),
  family: z.number().min(1).max(10),
  finances: z.number().min(1).max(10),
  fitness: z.number().min(1).max(10),
  friends: z.number().min(1).max(10),
  fun: z.number().min(1).max(10),
  career: z.number().min(1).max(10),
  contribution: z.number().min(1).max(10),
});

export const spiritualProfileSchema = z.object({
  wheelOfLifeScores: wheelOfLifeScoresSchema,
  primaryGrowthAreas: z.array(contentCategorySchema).min(1).max(3),
  spiritualGifts: z.array(z.string()).max(5),
});

// ============================================================================
// Reading Plan Schemas
// ============================================================================

export const createReadingPlanSchema = z.object({
  title: z.string().min(1, 'Title is required').max(200),
  description: z.string().min(1, 'Description is required').max(2000),
  category: contentCategorySchema,
  difficulty: difficultyLevelSchema,
  estimatedMinutesPerDay: z.number().int().min(1).max(120),
  imageUrl: urlSchema.optional().nullable(),
  tags: z.array(z.string().max(50)).max(10).default([]),
  targetAudience: z.array(z.string().max(100)).max(5).default([]),
});

export const updateReadingPlanSchema = createReadingPlanSchema.partial().extend({
  isFeatured: z.boolean().optional(),
  isPublished: z.boolean().optional(),
});

export const readingPlanDaySchema = z.object({
  dayNumber: z.number().int().min(1),
  title: z.string().min(1).max(200),
  scriptureReference: z.string().min(1).max(200),
  scriptureText: z.string().min(1).max(10000),
  devotionalContent: z.string().min(1).max(20000),
  reflectionPrompts: z.array(z.string().max(500)).min(1).max(5),
  applicationSteps: z.array(z.string().max(500)).max(5).default([]),
  prayerFocus: z.string().max(1000).optional().nullable(),
  audioUrl: urlSchema.optional().nullable(),
  estimatedMinutes: z.number().int().min(1).max(120),
});

export const completeReadingPlanDaySchema = z.object({
  dayNumber: z.number().int().min(1),
  idempotencyKey: z.string().min(1).max(100),
  reflectionContent: z.string().max(10000).optional(),
});

// ============================================================================
// Journey Schemas
// ============================================================================

export const createJourneySchema = z.object({
  title: z.string().min(1, 'Title is required').max(200),
  subtitle: z.string().max(200).optional().nullable(),
  description: z.string().min(1, 'Description is required').max(2000),
  category: contentCategorySchema,
  difficulty: difficultyLevelSchema,
  imageUrl: urlSchema.optional().nullable(),
  prerequisites: z.array(idSchema).default([]),
  outcomes: z.array(z.string().max(200)).min(1).max(10),
  tags: z.array(z.string().max(50)).max(10).default([]),
});

export const updateJourneySchema = createJourneySchema.partial().extend({
  isFeatured: z.boolean().optional(),
  isPublished: z.boolean().optional(),
});

export const journeyDaySchema = z.object({
  dayNumber: z.number().int().min(1),
  title: z.string().min(1).max(200),
  description: z.string().max(1000).optional().nullable(),
  scriptureReference: z.string().max(200).optional().nullable(),
  scriptureText: z.string().max(10000).optional().nullable(),
  teachingContent: z.string().min(1).max(30000),
  videoUrl: urlSchema.optional().nullable(),
  audioUrl: urlSchema.optional().nullable(),
  estimatedMinutes: z.number().int().min(1).max(180),
});

export const stepTypeSchema = z.enum([
  'scripture',
  'teaching',
  'reflection',
  'action',
  'prayer',
  'video',
  'audio',
  'quiz',
  'journal',
]);

export const journeyStepSchema = z.object({
  stepNumber: z.number().int().min(1),
  type: stepTypeSchema,
  title: z.string().min(1).max(200),
  content: z.string().min(1).max(20000),
  isRequired: z.boolean().default(true),
  metadata: z.record(z.unknown()).default({}),
});

export const completeJourneyStepSchema = z.object({
  stepId: idSchema,
  idempotencyKey: z.string().min(1).max(100),
  response: z.string().max(10000).optional(),
});

// ============================================================================
// Goal Schemas
// ============================================================================

export const goalModeSchema = z.enum(['classic', 'faith']);

export const habitFrequencySchema = z.enum(['daily', 'weekly', 'custom']);

export const habitSuggestionSchema = z.object({
  title: z.string().min(1).max(100),
  description: z.string().max(500),
  frequency: habitFrequencySchema,
  category: contentCategorySchema,
});

export const milestoneTemplateSchema = z.object({
  title: z.string().min(1).max(100),
  description: z.string().max(500),
  dayOffset: z.number().int().min(1).max(365),
});

export const createGoalTemplateSchema = z.object({
  title: z.string().min(1, 'Title is required').max(200),
  description: z.string().max(1000).optional().nullable(),
  category: contentCategorySchema,
  mode: goalModeSchema,
  defaultActions: z.array(z.string().max(200)).max(10).default([]),
  suggestedHabits: z.array(habitSuggestionSchema).max(5).default([]),
  reflectionPrompts: z.array(z.string().max(500)).max(5).default([]),
  milestones: z.array(milestoneTemplateSchema).max(10).default([]),
});

export const updateGoalTemplateSchema = createGoalTemplateSchema.partial().extend({
  isActive: z.boolean().optional(),
});

export const createUserGoalSchema = z.object({
  templateId: idSchema.optional().nullable(),
  title: z.string().min(1, 'Title is required').max(200),
  description: z.string().max(2000).optional().nullable(),
  category: contentCategorySchema,
  mode: goalModeSchema,
  targetDate: dateSchema.optional().nullable(),
  habits: z.array(z.object({
    title: z.string().min(1).max(100),
    description: z.string().max(500).optional().nullable(),
    frequency: habitFrequencySchema,
    customSchedule: z.array(z.number().int().min(0).max(6)).optional().nullable(),
  })).max(10).default([]),
});

export const updateUserGoalSchema = z.object({
  title: z.string().min(1).max(200).optional(),
  description: z.string().max(2000).optional().nullable(),
  targetDate: dateSchema.optional().nullable(),
  status: z.enum(['active', 'paused', 'completed', 'abandoned']).optional(),
});

export const completeHabitSchema = z.object({
  habitId: idSchema,
  date: dateSchema,
  notes: z.string().max(1000).optional().nullable(),
  idempotencyKey: z.string().min(1).max(100),
});

export const goalReflectionSchema = z.object({
  goalId: idSchema,
  weekNumber: z.number().int().min(1),
  content: z.string().min(1, 'Reflection content is required').max(10000),
  mood: z.number().int().min(1).max(5),
  challenges: z.array(z.string().max(200)).max(5).default([]),
  wins: z.array(z.string().max(200)).max(5).default([]),
});

// ============================================================================
// Journal Schemas
// ============================================================================

export const journalContextTypeSchema = z.enum([
  'general',
  'reading_plan_day',
  'journey_step',
  'spark',
  'goal_reflection',
  'prayer',
]);

export const createJournalEntrySchema = z.object({
  contextType: journalContextTypeSchema,
  contextId: idSchema.optional().nullable(),
  content: z.string().min(1, 'Content is required').max(50000),
  isPrivate: z.boolean().default(true),
  tags: z.array(z.string().max(50)).max(10).default([]),
});

export const updateJournalEntrySchema = z.object({
  content: z.string().min(1).max(50000).optional(),
  isPrivate: z.boolean().optional(),
  tags: z.array(z.string().max(50)).max(10).optional(),
});

// ============================================================================
// Group Schemas
// ============================================================================

export const groupTypeSchema = z.enum(['small_group', 'accountability', 'study', 'lab']);

export const groupMemberRoleSchema = z.enum(['member', 'facilitator', 'leader']);

export const groupSettingsSchema = z.object({
  allowMemberInvites: z.boolean(),
  requireApproval: z.boolean(),
  showMemberProgress: z.boolean(),
  enableDiscussions: z.boolean(),
  enablePrayerRequests: z.boolean(),
});

export const createGroupSchema = z.object({
  name: z.string().min(1, 'Name is required').max(100),
  description: z.string().max(1000).optional().nullable(),
  type: groupTypeSchema,
  imageUrl: urlSchema.optional().nullable(),
  maxMembers: z.number().int().min(2).max(100).optional().nullable(),
  isPublic: z.boolean().default(false),
  settings: groupSettingsSchema.default({
    allowMemberInvites: false,
    requireApproval: true,
    showMemberProgress: true,
    enableDiscussions: true,
    enablePrayerRequests: true,
  }),
});

export const updateGroupSchema = createGroupSchema.partial();

export const createDiscussionSchema = z.object({
  groupId: idSchema,
  contextType: z.enum(['general', 'journey_day', 'reading_plan_day', 'prayer']),
  contextId: idSchema.optional().nullable(),
  title: z.string().max(200).optional().nullable(),
  content: z.string().min(1, 'Content is required').max(10000),
});

export const createDiscussionReplySchema = z.object({
  discussionId: idSchema,
  content: z.string().min(1, 'Reply content is required').max(5000),
});

export const createPrayerRequestSchema = z.object({
  groupId: idSchema.optional().nullable(),
  title: z.string().min(1, 'Title is required').max(200),
  content: z.string().min(1, 'Content is required').max(5000),
  isAnonymous: z.boolean().default(false),
});

// ============================================================================
// Group Lab Schemas
// ============================================================================

export const createGroupLabSchema = z.object({
  groupId: idSchema,
  title: z.string().min(1, 'Title is required').max(200),
  description: z.string().min(1).max(2000),
  journeyId: idSchema.optional().nullable(),
  scheduledAt: dateSchema,
  duration: z.number().int().min(15).max(480), // 15 min to 8 hours
  maxParticipants: z.number().int().min(2).max(100).optional().nullable(),
  meetingUrl: urlSchema.optional().nullable(),
});

export const updateGroupLabSchema = createGroupLabSchema.partial().extend({
  status: z.enum(['scheduled', 'in_progress', 'completed', 'cancelled']).optional(),
});

// ============================================================================
// Search and Filter Schemas
// ============================================================================

export const contentSearchSchema = z.object({
  query: z.string().max(200).optional(),
  categories: z.array(contentCategorySchema).optional(),
  difficulty: z.array(difficultyLevelSchema).optional(),
  tags: z.array(z.string()).optional(),
  minDays: z.number().int().min(1).optional(),
  maxDays: z.number().int().max(365).optional(),
  isFeatured: z.boolean().optional(),
}).merge(paginationSchema);

export const userSearchSchema = z.object({
  query: z.string().max(100).optional(),
  role: z.array(userRoleSchema).optional(),
}).merge(paginationSchema);

// ============================================================================
// Export all schemas
// ============================================================================

export const schemas = {
  // Common
  email: emailSchema,
  password: passwordSchema,
  id: idSchema,
  uuid: uuidSchema,
  slug: slugSchema,
  url: urlSchema,
  date: dateSchema,
  contentCategory: contentCategorySchema,
  difficultyLevel: difficultyLevelSchema,
  pagination: paginationSchema,
  
  // User
  userRole: userRoleSchema,
  userProfileUpdate: userProfileUpdateSchema,
  notificationSettings: notificationSettingsSchema,
  displaySettings: displaySettingsSchema,
  privacySettings: privacySettingsSchema,
  userPreferences: userPreferencesSchema,
  wheelOfLifeScores: wheelOfLifeScoresSchema,
  spiritualProfile: spiritualProfileSchema,
  
  // Reading Plans
  createReadingPlan: createReadingPlanSchema,
  updateReadingPlan: updateReadingPlanSchema,
  readingPlanDay: readingPlanDaySchema,
  completeReadingPlanDay: completeReadingPlanDaySchema,
  
  // Journeys
  createJourney: createJourneySchema,
  updateJourney: updateJourneySchema,
  journeyDay: journeyDaySchema,
  journeyStep: journeyStepSchema,
  completeJourneyStep: completeJourneyStepSchema,
  
  // Goals
  goalMode: goalModeSchema,
  habitFrequency: habitFrequencySchema,
  createGoalTemplate: createGoalTemplateSchema,
  updateGoalTemplate: updateGoalTemplateSchema,
  createUserGoal: createUserGoalSchema,
  updateUserGoal: updateUserGoalSchema,
  completeHabit: completeHabitSchema,
  goalReflection: goalReflectionSchema,
  
  // Journal
  journalContextType: journalContextTypeSchema,
  createJournalEntry: createJournalEntrySchema,
  updateJournalEntry: updateJournalEntrySchema,
  
  // Groups
  groupType: groupTypeSchema,
  groupMemberRole: groupMemberRoleSchema,
  groupSettings: groupSettingsSchema,
  createGroup: createGroupSchema,
  updateGroup: updateGroupSchema,
  createDiscussion: createDiscussionSchema,
  createDiscussionReply: createDiscussionReplySchema,
  createPrayerRequest: createPrayerRequestSchema,
  
  // Group Labs
  createGroupLab: createGroupLabSchema,
  updateGroupLab: updateGroupLabSchema,
  
  // Search
  contentSearch: contentSearchSchema,
  userSearch: userSearchSchema,
};

// Type inference helpers
export type CreateReadingPlanInput = z.infer<typeof createReadingPlanSchema>;
export type UpdateReadingPlanInput = z.infer<typeof updateReadingPlanSchema>;
export type CreateJourneyInput = z.infer<typeof createJourneySchema>;
export type CreateUserGoalInput = z.infer<typeof createUserGoalSchema>;
export type CreateJournalEntryInput = z.infer<typeof createJournalEntrySchema>;
export type CreateGroupInput = z.infer<typeof createGroupSchema>;
export type ContentSearchInput = z.infer<typeof contentSearchSchema>;