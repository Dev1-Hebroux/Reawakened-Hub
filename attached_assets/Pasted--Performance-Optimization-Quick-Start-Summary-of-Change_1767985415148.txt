# Performance Optimization - Quick Start

## Summary of Changes

These optimizations reduce initial page load from **5+ sequential API calls** to **2 parallel calls**, cutting load time significantly.

## Files to Add/Update

### 1. Server-side

#### Add Performance Middleware (`server/middleware/performance.ts`)
```typescript
import { applyPerformanceMiddleware } from './middleware/performance';

// In your server setup (before routes)
applyPerformanceMiddleware(app);
```

#### Add Combined Endpoints

**`/api/init`** - Returns auth state, CSRF token, notifications in one call
**`/api/sparks/dashboard`** - Returns today's spark, featured, reflection card in one call

```typescript
// In server/routes.ts or server/index.ts
import { initRoutes } from './routes/init';
import { sparksDashboardRoutes } from './routes/sparksDashboard';

app.use('/api', initRoutes);
app.use('/api/sparks', sparksDashboardRoutes);
```

#### Update Auth Middleware (`server/middleware/auth.ts`)
Replace with `auth-middleware-optimized.ts`:
- Single query for session + user validation
- In-memory session cache
- Non-blocking activity updates

### 2. Client-side

#### Update AuthContext (`client/src/contexts/AuthContext.tsx`)
Replace with `AuthContext-optimized.tsx`:
- Cache auth state in sessionStorage
- Prefetch CSRF token on load
- Request deduplication

#### Add Dashboard Hook (`client/src/hooks/useDashboard.ts`)
Single hook that fetches all dashboard data:
```typescript
import { useDashboard } from '../hooks/useDashboard';

function Dashboard() {
  const { 
    todaySpark, 
    featuredSparks, 
    reflectionCard,
    userProgress,
    isLoading 
  } = useDashboard();
  
  // Render with data...
}
```

#### Update App Initialization
```typescript
// In main.tsx or App.tsx
import { prefetchDashboard } from './hooks/useDashboard';

// Prefetch on app load
const queryClient = new QueryClient();
prefetchDashboard(queryClient);
```

## Before & After

### Before (Current)
```
Page Load Timeline:
├── /api/auth/csrf ──────────────────> 50ms
├── /api/auth/me ────────────────────> 80ms (waits for csrf)
├── /api/notifications/unread-count ─> 160ms
├── /api/sparks/published ───────────> 200ms
├── /api/sparks/featured ────────────> 166ms
├── /api/reflection-cards/today ─────> 8ms
└── /api/leader-prayer-sessions ─────> 13ms

Total: ~677ms (sequential)
```

### After (Optimized)
```
Page Load Timeline:
├── /api/init ───────────────────────> 100ms (auth + csrf + notifications)
└── /api/sparks/dashboard ───────────> 150ms (all spark data)

Total: ~150ms (parallel)
```

## Checklist

- [ ] Install compression: `npm install compression @types/compression`
- [ ] Add performance middleware to server
- [ ] Add `/api/init` endpoint
- [ ] Add `/api/sparks/dashboard` endpoint
- [ ] Replace AuthContext with optimized version
- [ ] Add useDashboard hook
- [ ] Update Dashboard component to use useDashboard
- [ ] Update App initialization to prefetch
- [ ] Test with browser DevTools Network tab
- [ ] Run Lighthouse audit

## Quick Wins Without Code Changes

1. **Enable HTTP/2** in your hosting (Replit does this automatically)

2. **Add response compression** - Just add this line:
   ```typescript
   import compression from 'compression';
   app.use(compression());
   ```

3. **Add cache headers** for static content:
   ```typescript
   app.use('/api/sparks/featured', (req, res, next) => {
     res.set('Cache-Control', 'public, max-age=300');
     next();
   });
   ```

4. **Reduce bundle size** - Check with:
   ```bash
   npm run build
   du -sh dist/assets/*.js
   ```
   If > 500KB, add code splitting.

## Debugging

### Check API call count
Open DevTools > Network tab, filter by XHR/Fetch, reload page.
Should see only 2 requests instead of 5+.

### Check response times
Look at the `Server-Timing` header in responses (after adding middleware).

### Check compression
Look for `Content-Encoding: gzip` in response headers.

### Check caching
Look for `X-Cache: HIT` or 304 responses on repeated visits.